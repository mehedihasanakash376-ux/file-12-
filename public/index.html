<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Share files, images, videos, and text with the community" />
  <meta name="theme-color" content="#00d4ff" />
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/png" href="/icon.png">
  <link rel="stylesheet" href="style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <title>Nafij's Social Share</title>
</head>
<body>
  <!-- Header -->
  <header class="header" role="banner">
    <h1>🚀 Nafij's Social Share</h1>
    <button class="theme-toggle" id="theme-toggle" aria-label="Toggle dark mode">
      <span id="theme-icon">🌙</span>
    </button>
  </header>

  <!-- Main Content -->
  <main class="container" role="main">
    <!-- Welcome Section -->
    <section class="card welcome-card fade-in" aria-labelledby="welcome-heading">
      <h2 id="welcome-heading">Welcome to Nafij's Social Share! 🎉</h2>
      <p>Share your thoughts, images, videos, and files with the community. Discover amazing content from other users!</p>
    </section>

    <!-- Navigation -->
    <nav class="card navigation-card" role="navigation" aria-label="Site navigation">
      <div class="nav-buttons">
        <a href="/" class="btn btn-primary">🏠 Home</a>
        <a href="/post.html" class="btn btn-outline">✍️ New Post</a>
        <a href="/all.html" class="btn btn-outline">📋 All Posts</a>
        <a href="/profile.html" class="btn btn-outline">👤 Profile</a>
        <a href="/search.html" class="btn btn-outline">🔍 Search</a>
        <a href="/admin.html" class="btn btn-outline">⚙️ Admin</a>
      </div>
    </nav>

    <!-- Top Posts Section -->
    <section class="feed-section" id="feed-section" aria-labelledby="feed-heading">
      <h3 id="feed-heading">🔥 Top 10 Liked Posts</h3>
      <div id="posts-feed" class="posts-container" role="feed" aria-live="polite">
        <div class="loading-skeleton">
          <div class="skeleton-post"></div>
          <div class="skeleton-post"></div>
          <div class="skeleton-post"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- Scroll to Top Button -->
  <button class="scroll-top" id="scroll-top" aria-label="Scroll to top">
    ↑
  </button>

  <!-- Lightbox Modal -->
  <div id="lightbox" class="lightbox" role="dialog" aria-modal="true" aria-labelledby="lightbox-title">
    <div class="lightbox-content">
      <button class="lightbox-close" aria-label="Close lightbox">&times;</button>
      <div class="lightbox-media"></div>
      <div class="lightbox-controls">
        <button class="btn btn-outline" id="lightbox-download">⬇️ Download</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    // Global state
    let allPosts = [];

    // Theme Management
    const themeToggle = document.getElementById('theme-toggle');
    const themeIcon = document.getElementById('theme-icon');
    const body = document.body;

    // Load saved theme
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      body.classList.add('dark');
      themeIcon.textContent = '☀️';
    }

    themeToggle.addEventListener('click', () => {
      body.classList.toggle('dark');
      const isDark = body.classList.contains('dark');
      themeIcon.textContent = isDark ? '☀️' : '🌙';
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    });

    // Posts loading and display
    async function loadTopPosts() {
      try {
        const response = await fetch('/api/posts/top');
        const posts = await response.json();
        
        allPosts = posts;
        displayPosts(posts);
      } catch (error) {
        console.error('Error loading posts:', error);
        showNotification('Failed to load posts', 'error');
      }
    }

    function displayPosts(posts) {
      const container = document.getElementById('posts-feed');
      
      if (posts.length === 0) {
        container.innerHTML = '<div class="empty-state">No posts yet. Be the first to share something! 🚀</div>';
        return;
      }

      container.innerHTML = posts.map(post => createPostHTML(post)).join('');
      
      // Animate in
      setTimeout(() => {
        document.querySelectorAll('.post-card').forEach(card => {
          card.classList.add('fade-in');
        });
      }, 100);
    }

    function createPostHTML(post) {
      const timeAgo = getTimeAgo(new Date(post.createdAt));
      const userName = post.user || 'Anonymous';
      
      let mediaHTML = '';
      if (post.media && post.media.length > 0) {
        mediaHTML = post.media.map(file => {
          const mediaUrl = file.url;
          
          if (file.mimetype?.startsWith('image/')) {
            return `
              <div class="post-media">
                <img src="${mediaUrl}" alt="Post image" onclick="openLightbox('${mediaUrl}', 'image')" />
                <button class="media-download" onclick="downloadFile('${mediaUrl}', '${file.originalName}')" aria-label="Download image">⬇️</button>
              </div>
            `;
          } else if (file.mimetype?.startsWith('video/')) {
            return `
              <div class="post-media">
                <video controls preload="metadata">
                  <source src="${mediaUrl}" type="${file.mimetype}">
                  Your browser does not support the video tag.
                </video>
                <button class="media-download" onclick="downloadFile('${mediaUrl}', '${file.originalName}')" aria-label="Download video">⬇️</button>
              </div>
            `;
          } else if (file.mimetype?.startsWith('audio/')) {
            return `
              <div class="post-media">
                <audio controls preload="metadata">
                  <source src="${mediaUrl}" type="${file.mimetype}">
                  Your browser does not support the audio tag.
                </audio>
                <button class="media-download" onclick="downloadFile('${mediaUrl}', '${file.originalName}')" aria-label="Download audio">⬇️</button>
              </div>
            `;
          } else {
            return `
              <div class="post-media">
                <a href="${mediaUrl}" download target="_blank" class="file-attachment" aria-label="Download file">
                  📎 Download ${file.originalName}
                </a>
              </div>
            `;
          }
        }).join('');
      }

      return `
        <article class="post-card" data-post-id="${post._id}">
          <div class="post-header">
            <div class="post-author">
              <strong>${userName}</strong>
              <span class="post-time">${timeAgo}</span>
            </div>
          </div>
          
          ${post.text ? `<div class="post-content">${post.text}</div>` : ''}
          
          ${mediaHTML}
          
          <div class="post-actions">
            <button class="like-btn" onclick="likePost('${post._id}')">
              <span class="reaction-icon">❤️</span>
              <span class="like-count">${post.likes || 0}</span>
            </button>
          </div>
        </article>
      `;
    }

    // Post interactions
    async function likePost(postId) {
      try {
        const response = await fetch(`/api/posts/${postId}/like`, {
          method: 'POST'
        });
        
        if (response.ok) {
          const result = await response.json();
          const likeBtn = document.querySelector(`[data-post-id="${postId}"] .like-btn`);
          const likeCount = likeBtn.querySelector('.like-count');
          
          likeCount.textContent = result.likes;
          
          // Animate heart
          likeBtn.classList.add('pulse');
          setTimeout(() => likeBtn.classList.remove('pulse'), 300);
        }
      } catch (error) {
        console.error('Error liking post:', error);
      }
    }

    // Lightbox functionality
    function openLightbox(src, type) {
      const lightbox = document.getElementById('lightbox');
      const mediaContainer = lightbox.querySelector('.lightbox-media');
      
      if (type === 'image') {
        mediaContainer.innerHTML = `<img src="${src}" alt="Lightbox image" />`;
      } else if (type === 'video') {
        mediaContainer.innerHTML = `
          <video controls autoplay>
            <source src="${src}" type="video/mp4">
            Your browser does not support the video tag.
          </video>
        `;
      }
      
      lightbox.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      
      // Set download link
      const filename = src.split('/').pop();
      document.getElementById('lightbox-download').onclick = () => downloadFile(src, filename);
    }

    function closeLightbox() {
      const lightbox = document.getElementById('lightbox');
      lightbox.style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    // Close lightbox on click outside or escape key
    document.getElementById('lightbox').addEventListener('click', (e) => {
      if (e.target.id === 'lightbox') closeLightbox();
    });

    document.querySelector('.lightbox-close').addEventListener('click', closeLightbox);

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeLightbox();
    });

    function downloadFile(url, filename) {
      const a = document.createElement('a');
      a.href = url;
      a.download = filename || url.split('/').pop() || 'download';
      a.target = '_blank';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      
      showNotification('Download started', 'success');
    }

    // Utility functions
    function getTimeAgo(date) {
      const now = new Date();
      const diffInSeconds = Math.floor((now - date) / 1000);
      
      if (diffInSeconds < 60) return 'just now';
      if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
      if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
      if (diffInSeconds < 2592000) return `${Math.floor(diffInSeconds / 86400)}d ago`;
      
      return date.toLocaleDateString();
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.classList.add('show');
      }, 100);
      
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // Scroll to Top Button
    const scrollTopBtn = document.getElementById('scroll-top');
    
    window.addEventListener('scroll', () => {
      if (window.pageYOffset > 300) {
        scrollTopBtn.classList.add('visible');
      } else {
        scrollTopBtn.classList.remove('visible');
      }
    });

    scrollTopBtn.addEventListener('click', () => {
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    });

    // Initialize app
    document.addEventListener('DOMContentLoaded', () => {
      loadTopPosts();
      
      // Add intersection observer for animations
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('fade-in');
          }
        });
      });

      // Observe all cards for animation
      document.querySelectorAll('.card').forEach(card => {
        observer.observe(card);
      });
    });

    // Service Worker Registration
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js')
        .then(registration => {
          console.log('SW registered:', registration);
        })
        .catch(error => {
          console.log('SW registration failed:', error);
        });
    }
  </script>
</body>
</html>